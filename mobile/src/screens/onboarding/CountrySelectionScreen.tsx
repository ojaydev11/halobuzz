import React, { useState, useMemo } from 'react';
import {
  FlatList,
  Alert,
} from 'react-native';
import {
  Box,
  VStack,
  HStack,
  Text as NBText,
  Input,
  Icon,
  useColorModeValue,
  Pressable,
} from 'native-base';
import { Ionicons } from '@expo/vector-icons';
import { useAppDispatch } from '../../store/hooks';
import { selectCountry } from '../../store/slices/authSlice';

interface Country {
  code: string;
  name: string;
  flag: string;
  currency: string;
}

const countries: Country[] = [
  { code: 'NP', name: 'Nepal', flag: 'ğŸ‡³ğŸ‡µ', currency: 'NPR' },
  { code: 'IN', name: 'India', flag: 'ğŸ‡®ğŸ‡³', currency: 'INR' },
  { code: 'US', name: 'United States', flag: 'ğŸ‡ºğŸ‡¸', currency: 'USD' },
  { code: 'GB', name: 'United Kingdom', flag: 'ğŸ‡¬ğŸ‡§', currency: 'GBP' },
  { code: 'CA', name: 'Canada', flag: 'ğŸ‡¨ğŸ‡¦', currency: 'CAD' },
  { code: 'AU', name: 'Australia', flag: 'ğŸ‡¦ğŸ‡º', currency: 'AUD' },
  { code: 'DE', name: 'Germany', flag: 'ğŸ‡©ğŸ‡ª', currency: 'EUR' },
  { code: 'FR', name: 'France', flag: 'ğŸ‡«ğŸ‡·', currency: 'EUR' },
  { code: 'JP', name: 'Japan', flag: 'ğŸ‡¯ğŸ‡µ', currency: 'JPY' },
  { code: 'KR', name: 'South Korea', flag: 'ğŸ‡°ğŸ‡·', currency: 'KRW' },
  { code: 'SG', name: 'Singapore', flag: 'ğŸ‡¸ğŸ‡¬', currency: 'SGD' },
  { code: 'MY', name: 'Malaysia', flag: 'ğŸ‡²ğŸ‡¾', currency: 'MYR' },
  { code: 'TH', name: 'Thailand', flag: 'ğŸ‡¹ğŸ‡­', currency: 'THB' },
  { code: 'PH', name: 'Philippines', flag: 'ğŸ‡µğŸ‡­', currency: 'PHP' },
  { code: 'ID', name: 'Indonesia', flag: 'ğŸ‡®ğŸ‡©', currency: 'IDR' },
  { code: 'VN', name: 'Vietnam', flag: 'ğŸ‡»ğŸ‡³', currency: 'VND' },
  { code: 'BR', name: 'Brazil', flag: 'ğŸ‡§ğŸ‡·', currency: 'BRL' },
  { code: 'MX', name: 'Mexico', flag: 'ğŸ‡²ğŸ‡½', currency: 'MXN' },
  { code: 'AR', name: 'Argentina', flag: 'ğŸ‡¦ğŸ‡·', currency: 'ARS' },
  { code: 'CL', name: 'Chile', flag: 'ğŸ‡¨ğŸ‡±', currency: 'CLP' },
  { code: 'CO', name: 'Colombia', flag: 'ğŸ‡¨ğŸ‡´', currency: 'COP' },
  { code: 'PE', name: 'Peru', flag: 'ğŸ‡µğŸ‡ª', currency: 'PEN' },
  { code: 'ZA', name: 'South Africa', flag: 'ğŸ‡¿ğŸ‡¦', currency: 'ZAR' },
  { code: 'EG', name: 'Egypt', flag: 'ğŸ‡ªğŸ‡¬', currency: 'EGP' },
  { code: 'NG', name: 'Nigeria', flag: 'ğŸ‡³ğŸ‡¬', currency: 'NGN' },
  { code: 'KE', name: 'Kenya', flag: 'ğŸ‡°ğŸ‡ª', currency: 'KES' },
  { code: 'GH', name: 'Ghana', flag: 'ğŸ‡¬ğŸ‡­', currency: 'GHS' },
  { code: 'UG', name: 'Uganda', flag: 'ğŸ‡ºğŸ‡¬', currency: 'UGX' },
  { code: 'TZ', name: 'Tanzania', flag: 'ğŸ‡¹ğŸ‡¿', currency: 'TZS' },
  { code: 'ET', name: 'Ethiopia', flag: 'ğŸ‡ªğŸ‡¹', currency: 'ETB' },
  { code: 'RW', name: 'Rwanda', flag: 'ğŸ‡·ğŸ‡¼', currency: 'RWF' },
  { code: 'BI', name: 'Burundi', flag: 'ğŸ‡§ğŸ‡®', currency: 'BIF' },
  { code: 'MW', name: 'Malawi', flag: 'ğŸ‡²ğŸ‡¼', currency: 'MWK' },
  { code: 'ZM', name: 'Zambia', flag: 'ğŸ‡¿ğŸ‡²', currency: 'ZMW' },
  { code: 'ZW', name: 'Zimbabwe', flag: 'ğŸ‡¿ğŸ‡¼', currency: 'ZWL' },
  { code: 'BW', name: 'Botswana', flag: 'ğŸ‡§ğŸ‡¼', currency: 'BWP' },
  { code: 'NA', name: 'Namibia', flag: 'ğŸ‡³ğŸ‡¦', currency: 'NAD' },
  { code: 'LS', name: 'Lesotho', flag: 'ğŸ‡±ğŸ‡¸', currency: 'LSL' },
  { code: 'SZ', name: 'Eswatini', flag: 'ğŸ‡¸ğŸ‡¿', currency: 'SZL' },
  { code: 'MG', name: 'Madagascar', flag: 'ğŸ‡²ğŸ‡¬', currency: 'MGA' },
  { code: 'MU', name: 'Mauritius', flag: 'ğŸ‡²ğŸ‡º', currency: 'MUR' },
  { code: 'SC', name: 'Seychelles', flag: 'ğŸ‡¸ğŸ‡¨', currency: 'SCR' },
  { code: 'KM', name: 'Comoros', flag: 'ğŸ‡°ğŸ‡²', currency: 'KMF' },
  { code: 'DJ', name: 'Djibouti', flag: 'ğŸ‡©ğŸ‡¯', currency: 'DJF' },
  { code: 'SO', name: 'Somalia', flag: 'ğŸ‡¸ğŸ‡´', currency: 'SOS' },
  { code: 'ER', name: 'Eritrea', flag: 'ğŸ‡ªğŸ‡·', currency: 'ERN' },
  { code: 'SD', name: 'Sudan', flag: 'ğŸ‡¸ğŸ‡©', currency: 'SDG' },
  { code: 'SS', name: 'South Sudan', flag: 'ğŸ‡¸ğŸ‡¸', currency: 'SSP' },
  { code: 'CF', name: 'Central African Republic', flag: 'ğŸ‡¨ğŸ‡«', currency: 'XAF' },
  { code: 'TD', name: 'Chad', flag: 'ğŸ‡¹ğŸ‡©', currency: 'XAF' },
  { code: 'CM', name: 'Cameroon', flag: 'ğŸ‡¨ğŸ‡²', currency: 'XAF' },
  { code: 'GQ', name: 'Equatorial Guinea', flag: 'ğŸ‡¬ğŸ‡¶', currency: 'XAF' },
  { code: 'GA', name: 'Gabon', flag: 'ğŸ‡¬ğŸ‡¦', currency: 'XAF' },
  { code: 'CG', name: 'Republic of the Congo', flag: 'ğŸ‡¨ğŸ‡¬', currency: 'XAF' },
  { code: 'CD', name: 'Democratic Republic of the Congo', flag: 'ğŸ‡¨ğŸ‡©', currency: 'CDF' },
  { code: 'AO', name: 'Angola', flag: 'ğŸ‡¦ğŸ‡´', currency: 'AOA' },
  { code: 'ST', name: 'SÃ£o TomÃ© and PrÃ­ncipe', flag: 'ğŸ‡¸ğŸ‡¹', currency: 'STN' },
  { code: 'CV', name: 'Cape Verde', flag: 'ğŸ‡¨ğŸ‡»', currency: 'CVE' },
  { code: 'GM', name: 'Gambia', flag: 'ğŸ‡¬ğŸ‡²', currency: 'GMD' },
  { code: 'SN', name: 'Senegal', flag: 'ğŸ‡¸ğŸ‡³', currency: 'XOF' },
  { code: 'GN', name: 'Guinea', flag: 'ğŸ‡¬ğŸ‡³', currency: 'GNF' },
  { code: 'GW', name: 'Guinea-Bissau', flag: 'ğŸ‡¬ğŸ‡¼', currency: 'XOF' },
  { code: 'SL', name: 'Sierra Leone', flag: 'ğŸ‡¸ğŸ‡±', currency: 'SLL' },
  { code: 'LR', name: 'Liberia', flag: 'ğŸ‡±ğŸ‡·', currency: 'LRD' },
  { code: 'CI', name: 'Ivory Coast', flag: 'ğŸ‡¨ğŸ‡®', currency: 'XOF' },
  { code: 'BF', name: 'Burkina Faso', flag: 'ğŸ‡§ğŸ‡«', currency: 'XOF' },
  { code: 'ML', name: 'Mali', flag: 'ğŸ‡²ğŸ‡±', currency: 'XOF' },
  { code: 'NE', name: 'Niger', flag: 'ğŸ‡³ğŸ‡ª', currency: 'XOF' },
  { code: 'MR', name: 'Mauritania', flag: 'ğŸ‡²ğŸ‡·', currency: 'MRU' },
  { code: 'TN', name: 'Tunisia', flag: 'ğŸ‡¹ğŸ‡³', currency: 'TND' },
  { code: 'DZ', name: 'Algeria', flag: 'ğŸ‡©ğŸ‡¿', currency: 'DZD' },
  { code: 'MA', name: 'Morocco', flag: 'ğŸ‡²ğŸ‡¦', currency: 'MAD' },
  { code: 'LY', name: 'Libya', flag: 'ğŸ‡±ğŸ‡¾', currency: 'LYD' },
  { code: 'JO', name: 'Jordan', flag: 'ğŸ‡¯ğŸ‡´', currency: 'JOD' },
  { code: 'LB', name: 'Lebanon', flag: 'ğŸ‡±ğŸ‡§', currency: 'LBP' },
  { code: 'SY', name: 'Syria', flag: 'ğŸ‡¸ğŸ‡¾', currency: 'SYP' },
  { code: 'IQ', name: 'Iraq', flag: 'ğŸ‡®ğŸ‡¶', currency: 'IQD' },
  { code: 'IR', name: 'Iran', flag: 'ğŸ‡®ğŸ‡·', currency: 'IRR' },
  { code: 'AF', name: 'Afghanistan', flag: 'ğŸ‡¦ğŸ‡«', currency: 'AFN' },
  { code: 'PK', name: 'Pakistan', flag: 'ğŸ‡µğŸ‡°', currency: 'PKR' },
  { code: 'BD', name: 'Bangladesh', flag: 'ğŸ‡§ğŸ‡©', currency: 'BDT' },
  { code: 'LK', name: 'Sri Lanka', flag: 'ğŸ‡±ğŸ‡°', currency: 'LKR' },
  { code: 'MV', name: 'Maldives', flag: 'ğŸ‡²ğŸ‡»', currency: 'MVR' },
  { code: 'BT', name: 'Bhutan', flag: 'ğŸ‡§ğŸ‡¹', currency: 'BTN' },
  { code: 'MM', name: 'Myanmar', flag: 'ğŸ‡²ğŸ‡²', currency: 'MMK' },
  { code: 'LA', name: 'Laos', flag: 'ğŸ‡±ğŸ‡¦', currency: 'LAK' },
  { code: 'KH', name: 'Cambodia', flag: 'ğŸ‡°ğŸ‡­', currency: 'KHR' },
  { code: 'MN', name: 'Mongolia', flag: 'ğŸ‡²ğŸ‡³', currency: 'MNT' },
  { code: 'KZ', name: 'Kazakhstan', flag: 'ğŸ‡°ğŸ‡¿', currency: 'KZT' },
  { code: 'UZ', name: 'Uzbekistan', flag: 'ğŸ‡ºğŸ‡¿', currency: 'UZS' },
  { code: 'KG', name: 'Kyrgyzstan', flag: 'ğŸ‡°ğŸ‡¬', currency: 'KGS' },
  { code: 'TJ', name: 'Tajikistan', flag: 'ğŸ‡¹ğŸ‡¯', currency: 'TJS' },
  { code: 'TM', name: 'Turkmenistan', flag: 'ğŸ‡¹ğŸ‡²', currency: 'TMT' },
  { code: 'AZ', name: 'Azerbaijan', flag: 'ğŸ‡¦ğŸ‡¿', currency: 'AZN' },
  { code: 'GE', name: 'Georgia', flag: 'ğŸ‡¬ğŸ‡ª', currency: 'GEL' },
  { code: 'AM', name: 'Armenia', flag: 'ğŸ‡¦ğŸ‡²', currency: 'AMD' },
  { code: 'TR', name: 'Turkey', flag: 'ğŸ‡¹ğŸ‡·', currency: 'TRY' },
  { code: 'CY', name: 'Cyprus', flag: 'ğŸ‡¨ğŸ‡¾', currency: 'EUR' },
  { code: 'GR', name: 'Greece', flag: 'ğŸ‡¬ğŸ‡·', currency: 'EUR' },
  { code: 'IT', name: 'Italy', flag: 'ğŸ‡®ğŸ‡¹', currency: 'EUR' },
  { code: 'ES', name: 'Spain', flag: 'ğŸ‡ªğŸ‡¸', currency: 'EUR' },
  { code: 'PT', name: 'Portugal', flag: 'ğŸ‡µğŸ‡¹', currency: 'EUR' },
  { code: 'NL', name: 'Netherlands', flag: 'ğŸ‡³ğŸ‡±', currency: 'EUR' },
  { code: 'BE', name: 'Belgium', flag: 'ğŸ‡§ğŸ‡ª', currency: 'EUR' },
  { code: 'LU', name: 'Luxembourg', flag: 'ğŸ‡±ğŸ‡º', currency: 'EUR' },
  { code: 'AT', name: 'Austria', flag: 'ğŸ‡¦ğŸ‡¹', currency: 'EUR' },
  { code: 'CH', name: 'Switzerland', flag: 'ğŸ‡¨ğŸ‡­', currency: 'CHF' },
  { code: 'LI', name: 'Liechtenstein', flag: 'ğŸ‡±ğŸ‡®', currency: 'CHF' },
  { code: 'MC', name: 'Monaco', flag: 'ğŸ‡²ğŸ‡¨', currency: 'EUR' },
  { code: 'SM', name: 'San Marino', flag: 'ğŸ‡¸ğŸ‡²', currency: 'EUR' },
  { code: 'VA', name: 'Vatican City', flag: 'ğŸ‡»ğŸ‡¦', currency: 'EUR' },
  { code: 'AD', name: 'Andorra', flag: 'ğŸ‡¦ğŸ‡©', currency: 'EUR' },
  { code: 'PL', name: 'Poland', flag: 'ğŸ‡µğŸ‡±', currency: 'PLN' },
  { code: 'CZ', name: 'Czech Republic', flag: 'ğŸ‡¨ğŸ‡¿', currency: 'CZK' },
  { code: 'SK', name: 'Slovakia', flag: 'ğŸ‡¸ğŸ‡°', currency: 'EUR' },
  { code: 'HU', name: 'Hungary', flag: 'ğŸ‡­ğŸ‡º', currency: 'HUF' },
  { code: 'RO', name: 'Romania', flag: 'ğŸ‡·ğŸ‡´', currency: 'RON' },
  { code: 'BG', name: 'Bulgaria', flag: 'ğŸ‡§ğŸ‡¬', currency: 'BGN' },
  { code: 'HR', name: 'Croatia', flag: 'ğŸ‡­ğŸ‡·', currency: 'EUR' },
  { code: 'SI', name: 'Slovenia', flag: 'ğŸ‡¸ğŸ‡®', currency: 'EUR' },
  { code: 'EE', name: 'Estonia', flag: 'ğŸ‡ªğŸ‡ª', currency: 'EUR' },
  { code: 'LV', name: 'Latvia', flag: 'ğŸ‡±ğŸ‡»', currency: 'EUR' },
  { code: 'LT', name: 'Lithuania', flag: 'ğŸ‡±ğŸ‡¹', currency: 'EUR' },
  { code: 'FI', name: 'Finland', flag: 'ğŸ‡«ğŸ‡®', currency: 'EUR' },
  { code: 'SE', name: 'Sweden', flag: 'ğŸ‡¸ğŸ‡ª', currency: 'SEK' },
  { code: 'NO', name: 'Norway', flag: 'ğŸ‡³ğŸ‡´', currency: 'NOK' },
  { code: 'DK', name: 'Denmark', flag: 'ğŸ‡©ğŸ‡°', currency: 'DKK' },
  { code: 'IS', name: 'Iceland', flag: 'ğŸ‡®ğŸ‡¸', currency: 'ISK' },
  { code: 'IE', name: 'Ireland', flag: 'ğŸ‡®ğŸ‡ª', currency: 'EUR' },
  { code: 'MT', name: 'Malta', flag: 'ğŸ‡²ğŸ‡¹', currency: 'EUR' },
  { code: 'RU', name: 'Russia', flag: 'ğŸ‡·ğŸ‡º', currency: 'RUB' },
  { code: 'BY', name: 'Belarus', flag: 'ğŸ‡§ğŸ‡¾', currency: 'BYN' },
  { code: 'UA', name: 'Ukraine', flag: 'ğŸ‡ºğŸ‡¦', currency: 'UAH' },
  { code: 'MD', name: 'Moldova', flag: 'ğŸ‡²ğŸ‡©', currency: 'MDL' },
  { code: 'RS', name: 'Serbia', flag: 'ğŸ‡·ğŸ‡¸', currency: 'RSD' },
  { code: 'ME', name: 'Montenegro', flag: 'ğŸ‡²ğŸ‡ª', currency: 'EUR' },
  { code: 'BA', name: 'Bosnia and Herzegovina', flag: 'ğŸ‡§ğŸ‡¦', currency: 'BAM' },
  { code: 'MK', name: 'North Macedonia', flag: 'ğŸ‡²ğŸ‡°', currency: 'MKD' },
  { code: 'AL', name: 'Albania', flag: 'ğŸ‡¦ğŸ‡±', currency: 'ALL' },
  { code: 'XK', name: 'Kosovo', flag: 'ğŸ‡½ğŸ‡°', currency: 'EUR' },
  { code: 'IL', name: 'Israel', flag: 'ğŸ‡®ğŸ‡±', currency: 'ILS' },
  { code: 'PS', name: 'Palestine', flag: 'ğŸ‡µğŸ‡¸', currency: 'ILS' },
  { code: 'SA', name: 'Saudi Arabia', flag: 'ğŸ‡¸ğŸ‡¦', currency: 'SAR' },
  { code: 'AE', name: 'United Arab Emirates', flag: 'ğŸ‡¦ğŸ‡ª', currency: 'AED' },
  { code: 'QA', name: 'Qatar', flag: 'ğŸ‡¶ğŸ‡¦', currency: 'QAR' },
  { code: 'KW', name: 'Kuwait', flag: 'ğŸ‡°ğŸ‡¼', currency: 'KWD' },
  { code: 'BH', name: 'Bahrain', flag: 'ğŸ‡§ğŸ‡­', currency: 'BHD' },
  { code: 'OM', name: 'Oman', flag: 'ğŸ‡´ğŸ‡²', currency: 'OMR' },
  { code: 'YE', name: 'Yemen', flag: 'ğŸ‡¾ğŸ‡ª', currency: 'YER' },
  { code: 'AE', name: 'United Arab Emirates', flag: 'ğŸ‡¦ğŸ‡ª', currency: 'AED' },
  { code: 'QA', name: 'Qatar', flag: 'ğŸ‡¶ğŸ‡¦', currency: 'QAR' },
  { code: 'KW', name: 'Kuwait', flag: 'ğŸ‡°ğŸ‡¼', currency: 'KWD' },
  { code: 'BH', name: 'Bahrain', flag: 'ğŸ‡§ğŸ‡­', currency: 'BHD' },
  { code: 'OM', name: 'Oman', flag: 'ğŸ‡´ğŸ‡²', currency: 'OMR' },
  { code: 'YE', name: 'Yemen', flag: 'ğŸ‡¾ğŸ‡ª', currency: 'YER' },
];

const CountrySelectionScreen: React.FC = () => {
  const dispatch = useAppDispatch();
  const [searchQuery, setSearchQuery] = useState('');

  const backgroundColor = useColorModeValue('background.primary', 'background.primary');
  const textColor = useColorModeValue('text.primary', 'text.primary');
  const cardBackground = useColorModeValue('background.secondary', 'background.secondary');
  const inputBackground = useColorModeValue('background.tertiary', 'background.tertiary');

  const filteredCountries = useMemo(() => {
    return countries.filter(country =>
      country.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
      country.code.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }, [searchQuery]);

  const handleCountrySelect = (country: Country) => {
    dispatch(selectCountry(country.code));
  };

  const renderCountryItem = ({ item }: { item: Country }) => (
    <Pressable
      onPress={() => handleCountrySelect(item)}
      _pressed={{ opacity: 0.7 }}
    >
      <Box
        bg={cardBackground}
        p={4}
        mb={2}
        borderRadius="lg"
        borderWidth={1}
        borderColor="background.tertiary"
      >
        <HStack alignItems="center" space={3}>
          <NBText fontSize="2xl">{item.flag}</NBText>
          <VStack flex={1}>
            <NBText color={textColor} fontWeight="semibold" fontSize="md">
              {item.name}
            </NBText>
            <NBText color="text.secondary" fontSize="sm">
              {item.currency}
            </NBText>
          </VStack>
          <Icon
            as={Ionicons}
            name="chevron-forward"
            size="sm"
            color="text.secondary"
          />
        </HStack>
      </Box>
    </Pressable>
  );

  return (
    <Box flex={1} bg={backgroundColor} safeArea>
      <VStack flex={1} px={4}>
        {/* Header */}
        <VStack alignItems="center" mb={6} pt={4}>
          <Icon
            as={Ionicons}
            name="globe"
            size="4xl"
            color="primary.500"
            mb={3}
          />
          <NBText fontSize="2xl" fontWeight="bold" color={textColor} textAlign="center" mb={2}>
            Select Your Country
          </NBText>
          <NBText fontSize="md" color="text.secondary" textAlign="center">
            This helps us provide localized content and payment options
          </NBText>
        </VStack>

        {/* Search Input */}
        <Box mb={4}>
          <Input
            placeholder="Search countries..."
            value={searchQuery}
            onChangeText={setSearchQuery}
            bg={inputBackground}
            borderColor="background.tertiary"
            _focus={{ borderColor: 'primary.500' }}
            InputLeftElement={
              <Icon
                as={Ionicons}
                name="search"
                size="sm"
                color="text.secondary"
                ml={3}
              />
            }
          />
        </Box>

        {/* Countries List */}
        <FlatList
          data={filteredCountries}
          renderItem={renderCountryItem}
          keyExtractor={(item) => item.code}
          showsVerticalScrollIndicator={false}
          contentContainerStyle={{ paddingBottom: 20 }}
        />
      </VStack>
    </Box>
  );
};

export default CountrySelectionScreen;
